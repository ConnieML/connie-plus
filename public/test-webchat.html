<!DOCTYPE html>
<html>
<head>
    <title>WebChat Test</title>
</head>
<body>
    <h1>WebChat Test</h1>
    <div id="twilio-webchat-widget-root"></div>
    
    <script defer src="https://media.twiliocdn.com/sdk/js/webchat-v3/releases/3.3.0/webchat.min.js" 
            integrity="sha256-ydLLXnNrb26iFUvKAHsYt9atwfzz0LNcgBmo0NmD5Uk=" 
            crossorigin="anonymous"></script>
    <script>
        window.addEventListener("load", () => {
            console.log('Page loaded');
            console.log('Twilio available:', !!window.Twilio);
            console.log('Twilio keys:', window.Twilio ? Object.keys(window.Twilio) : 'none');
            
            // Detect organization from referrer and use appropriate deployment key
            const referrer = document.referrer;
            console.log('Referrer:', referrer);
            
            // Single deployment key for all support channels - dynamic organization detection
            const deploymentKey = 'CV8c8c75ecb84c0208b1166dbe53bdb81a'; // ConnieRTC Support Channel
            let organizationName;
            
            // Detect organization from referrer
            if (referrer.includes('nss.connie.team')) {
                organizationName = 'NSS';
            } else if (referrer.includes('hhovv.connie.team')) {
                organizationName = 'HHOVV';
            } else if (referrer.includes('dev.connie.team')) {
                organizationName = 'DevSandBox';
            } else if (referrer.includes('localhost:3000')) {
                organizationName = 'DevSandBox (localhost)';
            } else {
                // Fallback to NSS if referrer doesn't match
                organizationName = 'NSS (fallback)';
                console.warn('Unknown referrer, defaulting to NSS');
            }
            
            console.log(`Detected organization: ${organizationName}`);
            console.log(`Using single ConnieRTC Support deployment key: ${deploymentKey}`);
            
            if (window.Twilio && window.Twilio.initWebchat) {
                const appConfig = {
                    deploymentKey: deploymentKey,
                    context: {
                        organization: organizationName,
                        referrer: referrer,
                        source: 'enhanced_crm_container'
                    }
                }
                console.log(`Initializing WebChat for ${organizationName} via single support channel...`);
                window.Twilio.initWebchat(appConfig);
                console.log('WebChat initialized with dynamic organization context!');
            } else {
                console.error('WebChat not available');
            }
        })
    </script>
</body>
</html>