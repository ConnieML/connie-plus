<!DOCTYPE html>
<html>
<head>
    <title>WebChat Test</title>
</head>
<body>
    <h1>WebChat Test</h1>
    <div id="twilio-webchat-widget-root"></div>
    
    <script defer src="https://media.twiliocdn.com/sdk/js/webchat-v3/releases/3.3.0/webchat.min.js" 
            integrity="sha256-ydLLXnNrb26iFUvKAHsYt9atwfzz0LNcgBmo0NmD5Uk=" 
            crossorigin="anonymous"></script>
    <script>
        window.addEventListener("load", () => {
            console.log('Page loaded');
            console.log('Twilio available:', !!window.Twilio);
            console.log('Twilio keys:', window.Twilio ? Object.keys(window.Twilio) : 'none');
            
            // Get organization and source from URL parameters (passed from get-help.tsx)
            const urlParams = new URLSearchParams(window.location.search);
            const orgFromParam = urlParams.get('org');
            const sourceFromParam = urlParams.get('source');
            
            // Also check document.referrer as fallback
            const referrer = document.referrer;
            console.log('URL Parameters:', { org: orgFromParam, source: sourceFromParam });
            console.log('Document Referrer:', referrer);
            
            // Single deployment key for all support channels - dynamic organization detection
            const deploymentKey = 'CV8c8c75ecb84c0208b1166dbe53bdb81a'; // ConnieRTC Support Channel
            let organizationName;
            
            // Priority 1: Use org parameter if provided
            if (orgFromParam) {
                organizationName = orgFromParam;
                console.log(`Using organization from URL parameter: ${organizationName}`);
            }
            // Priority 2: Detect from source parameter (original referrer)
            else if (sourceFromParam) {
                if (sourceFromParam.includes('nss.connie.team')) {
                    organizationName = 'NSS';
                } else if (sourceFromParam.includes('hhovv.connie.team')) {
                    organizationName = 'HHOVV';
                } else if (sourceFromParam.includes('dev.connie.team')) {
                    organizationName = 'DevSandBox';
                } else if (sourceFromParam.includes('localhost:3000')) {
                    organizationName = 'DevSandBox (localhost)';
                } else {
                    organizationName = 'NSS (source fallback)';
                }
                console.log(`Detected organization from source parameter: ${organizationName}`);
            }
            // Priority 3: Detect from document referrer (legacy)
            else if (referrer.includes('nss.connie.team')) {
                organizationName = 'NSS';
            } else if (referrer.includes('hhovv.connie.team')) {
                organizationName = 'HHOVV';
            } else if (referrer.includes('dev.connie.team')) {
                organizationName = 'DevSandBox';
            } else if (referrer.includes('localhost:3000')) {
                organizationName = 'DevSandBox (localhost)';
            } else {
                // Final fallback
                organizationName = 'NSS (final fallback)';
                console.warn('Could not detect organization from any source, defaulting to NSS');
            }
            
            console.log(`Detected organization: ${organizationName}`);
            console.log(`Using single ConnieRTC Support deployment key: ${deploymentKey}`);
            
            if (window.Twilio && window.Twilio.initWebchat) {
                const appConfig = {
                    deploymentKey: deploymentKey,
                    context: {
                        organization: organizationName,
                        referrer: referrer,
                        originalSource: sourceFromParam || referrer,
                        source: 'enhanced_crm_container',
                        page: 'test-webchat'
                    }
                }
                console.log(`Initializing WebChat for ${organizationName} via single support channel...`);
                window.Twilio.initWebchat(appConfig);
                console.log('WebChat initialized with dynamic organization context!');
            } else {
                console.error('WebChat not available');
            }
        })
    </script>
</body>
</html>